---
description: 
globs: 
alwaysApply: true
---
â¸»

ğŸ“œ Astryn â€“ Project-Specific Rules

â¸»

ğŸ§± General Architecture Rules
	1.	Service-Oriented Structure:
Astryn is composed of modular services:
	â€¢	telegram_bot/
	â€¢	agent_api/ (FastAPI, Agno-compliant)
	â€¢	workers/ (generation_worker.py, minting_worker.py, notify_user.py)
	â€¢	queue/ (RabbitMQ broker)
	2.	Asynchronous by Default:
All services must use asyncio to prevent blocking operations (AI generation, API calls, Telegram messaging, etc.).
	3.	Supabase as the Source of Truth:
No job state is kept in-memory alone. All jobs must be persisted in Supabase with atomic updates (job.status, is_paid, etc.).
	4.	RabbitMQ as Job Dispatcher:
Long-running or rate-limited tasks (generation, minting, notification) must be queued. Never run blocking tasks directly from HTTP or bot handlers.

â¸»

ğŸ’° Payment & Job Flow Rules
	1.	No Work Without Payment:
Jobs should not proceed (generation or minting) until is_paid = true.
	2.	Tier-Based Pricing:
	â€¢	Tier 1: tier = manual â†’ lower price, direct mint
	â€¢	Tier 2: tier = ai_generated â†’ higher price, queued generation
	3.	Payment Confirmation via Masumi Webhook Only:
Bot or user cannot manually mark a job as paid. Only Masumi callbacks can do this.

â¸»

ğŸ¨ Generation Rules
	1.	Content Creation Only When Paid:
AI generation is triggered only after is_paid = true and tier = ai_generated.
	2.	Supported Media Types:
	â€¢	Image: Static (via DALLÂ·E, SDXL)
	â€¢	Video: Short loops (via AnimateDiff, RunwayML)
	3.	Prompt Validity:
Prompt input must be â‰¥5 characters and safely filtered (no unsafe/genitalia/etc.)
	4.	File Size & Format Validation:
	â€¢	User-uploaded content must be under 20MB
	â€¢	Accepted: .jpg, .png, .mp4, .mov

â¸»

ğŸ§¾ Minting Rules
	1.	One NFT per Job:
Each job results in a single mint, mapped to a unique tx_hash.
	2.	NMKR Minting Policy:
	â€¢	Metadata includes: creator handle, tier, generation method (manual/ai)
	â€¢	Use dynamic asset names (e.g., AstrynNFT-0001)
	â€¢	Royalties fixed at 5% to Astryn wallet (editable)
	3.	Delivery via Telegram:
Minting must be followed by a Telegram DM with:
	â€¢	Success message
	â€¢	NFT link
	â€¢	Cardano explorer link (for tx_hash)

â¸»

ğŸ§  Agent Rules
	1.	Masumi & Agno Compliant:
	â€¢	Astryn exposes /start_job, /status, /input_schema, /output_schema
	â€¢	Only accepts MIP-003 valid job payloads
	2.	API-Accessible:
Astrynâ€™s generation + minting capabilities are exposed via public API (with payment gating).
	3.	No Direct Job Start from API:
All external jobs must go through /start_job â†’ payment â†’ queue

â¸»

ğŸ“Š Monitoring & Observability Rules
	1.	Every Worker Logs to Braintrust:
	â€¢	Job start time
	â€¢	Job duration
	â€¢	Success/failure
	â€¢	Retry count
	2.	Error Reporting:
	â€¢	Max retries = 3
	â€¢	After 3 failures â†’ set status = error and store last_error
	3.	Notifications on Failure:
	â€¢	Telegram user should receive a graceful failure message with support option

â¸»

ğŸ“ File & Directory Naming Rules
	â€¢	All services: snake_case
	â€¢	Worker files: minting_worker.py, generation_worker.py, notify_worker.py
	â€¢	Configs: env.py, settings.py
	â€¢	Agent API routes: /api/job, /api/status, /api/docs

â¸»

ğŸ§ª Testing & DevOps Rules
	1.	Testable Components:
Each worker must be runnable in standalone test mode:

python workers/minting_worker.py --test job_id


	2.	Docker-First Local Dev:
Local dev must be supported with Docker Compose:
	â€¢	supabase, rabbitmq, workers, api, bot
	3.	Secrets & API Keys:
Stored in .env and managed via environment variables

â¸»

ğŸ¤– Telegram Bot Rules
	1.	No Minting in DMs Without Wallet
Every job must contain a valid Cardano wallet address.
	2.	Status Feedback Loop
Users can run /status or tap â€œğŸ” Check Statusâ€ to view progress of their job
	3.	No Spamming
Rate-limit command usage to avoid abuse. Use Bot API throttling if necessary.
