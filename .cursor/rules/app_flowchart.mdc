---
description: 
globs: 
alwaysApply: true
---
flowchart TD
    A[User starts Telegram bot (/start or message)]
    B[Bot: Ask for Prompt or Upload (image/video)]
    C[Bot: Ask for Cardano Wallet Address]
    D[Bot: Detect Tier (manual or ai_generated)]
    E[Create Job in Supabase (status: awaiting_payment)]
    F[Send Masumi Payment Link to User]
    G[Masumi: Payment Received (Webhook)]
    H[Update Job: is_paid = true]
    I{Tier Check}
    J1[Enqueue to RabbitMQ: generate_nft]
    J2[Enqueue to RabbitMQ: mint_nft]
    K[Worker: Generate Image/Video]
    L[Upload Generated Media to Supabase Storage]
    M[Update Job with Media URL]
    N[Enqueue to RabbitMQ: mint_nft]
    O[Worker: Mint NFT via NMKR API]
    P[Update Job: status = complete, store tx_hash]
    Q[Enqueue to RabbitMQ: notify_user]
    R[Worker: Send Telegram Message with IPFS + Tx Link]
    S[User Receives NFT + Metadata]
    T[Trace All Stages with Braintrust]

    %% Flow
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    I -->|ai_generated| J1
    I -->|manual upload| J2
    J1 --> K
    K --> L
    L --> M
    M --> N
    J2 --> O
    N --> O
    O --> P
    P --> Q
    Q --> R
    R --> S

    %% Monitoring
    B --> T
    K --> T
    O --> T
    R --> T