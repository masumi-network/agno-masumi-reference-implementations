---
description: 
globs: 
alwaysApply: true
---
â¸»

ğŸŒŒ Astryn â€“ Telegram NFT Agent: Full Implementation Plan

(With RabbitMQ queueing, Agno agent interface, RAG via VectorDB, and Masumi payments)

â¸»

ğŸ§± Phase 1: Architecture & Tiered Flow Design

ğŸ§  Stack Overview

Component	Tech
Bot Interface	Telegram (aiogram or grammY)
Agent Framework	Agno Agent SDK (MIP-003)
Monetization	Masumi
NFT Minting	NMKR Studio API
Database/Auth	Supabase with MCP (via Cursor)
Media Storage	Supabase Storage
Monitoring	Braintrust
Content Generation	DALLÂ·E, SDXL, AnimateDiff, RunwayML
Queue System	ğŸ†• RabbitMQ
Workers	Async Python workers (Pika or Celery)
RAG / Retrieval	Agno VectorDB



â¸»

âš™ï¸ Phase 2: Supabase Schema Setup

Table	Fields
users	id, telegram_id, wallet, â€¦
nft_jobs	id, tier, status, prompt, media_url, generated_media_url, tx_hash, is_paid, retry_count, last_error, created_at, updated_at
payments	id, job_id, masumi_job_id, status, amount

âœ… Status Flow:

awaiting_payment â†’ paid â†’ queued_generation â†’ generating â†’ queued_minting â†’ minting â†’ complete â†’ notified



â¸»

ğŸ¤– Phase 3: Telegram Bot Integration

âœ… Bot Flow
	â€¢	/start
	â€¢	Accepts:
	â€¢	File upload (Tier 1 â€“ manual content)
	â€¢	Prompt (Tier 2 â€“ AI-generated content)
	â€¢	Requests Cardano wallet
	â€¢	Generates Masumi payment link
	â€¢	After payment:
	â€¢	Tier 1 â†’ enqueue to mint_nft
	â€¢	Tier 2 â†’ enqueue to generate_nft

â¸»

ğŸ’¸ Phase 4: Masumi Monetization Integration
	â€¢	Masumi used for job-level payment gating
	â€¢	Payment link includes:
	â€¢	Job ID, tier, wallet address, media type
	â€¢	On payment confirmation (via webhook):
	â€¢	Update Supabase (status = paid)
	â€¢	Enqueue job into appropriate RabbitMQ queue

â¸»

ğŸ§° Phase 5: RabbitMQ Job Queueing System

ğŸ¯ Queue Names

Queue	Description
generate_nft	Tier 2 jobs after payment
mint_nft	All mint-ready jobs
notify_user	Post-mint Telegram notifications

ğŸ§µ Worker Services

generation_worker.py
	â€¢	Consumes generate_nft
	â€¢	Uses RAG-enhanced prompt (Agno VectorDB)
	â€¢	Generates media â†’ uploads to Supabase
	â€¢	Updates job â†’ pushes to mint_nft

minting_worker.py
	â€¢	Consumes mint_nft
	â€¢	Uploads to NMKR â†’ mints to wallet
	â€¢	Updates tx hash â†’ pushes to notify_user

notification_worker.py
	â€¢	Sends Telegram message with NFT metadata + links

ğŸ” Retry & Monitoring
	â€¢	Max retries: 3 (retry_count)
	â€¢	Log last_error
	â€¢	If worker dies, fallback to polling Supabase queue

â¸»

ğŸ” Phase 6: Content Generation

Condition	Action
tier = ai_generated & is_paid	â†’ enqueue to generate_nft
tier = manual & is_paid	â†’ enqueue directly to mint_nft

	â€¢	RAG system enhances prompts before generation
	â€¢	Supports multiple models: SDXL, DALLÂ·E, AnimateDiff

â¸»

ğŸ”¥ Phase 7: NMKR Minting Integration
	â€¢	Receives media from user or generation worker
	â€¢	Uploads to NMKR (metadata + asset)
	â€¢	Mints to provided Cardano wallet
	â€¢	Updates Supabase with tx_hash and status = complete

â¸»

ğŸ§  Phase 8: Agno Agent Integration
	â€¢	Built with Agno SDK for agent composability
	â€¢	Agent exposes public MIP-003 endpoints:
	â€¢	/input_schema, /output_schema, /start_job, /status
	â€¢	Can be used by other Agno agents or tools
	â€¢	/queue_job allows internal testing and inter-agent coordination

â¸»

ğŸ“š Phase 9: RAG Integration with Agno VectorDB
	â€¢	Stores NFT styles, themes, instructions, and user history
	â€¢	Used to enhance prompts before generation (prompt â†’ RAG â†’ enriched prompt)
	â€¢	Also powers /help and conversational responses
	â€¢	Uses RetrievalChain via Agnoâ€™s VectorDB SDK

â¸»

ğŸ“Š Phase 10: Monitoring with Braintrust
	â€¢	All workers integrate Braintrust SDK
	â€¢	Track:
	â€¢	Job duration
	â€¢	Error/retry rate
	â€¢	Revenue per job
	â€¢	Expose in dashboard or alert system

â¸»

ğŸ§¬ Phase 11: Polish & Launch
	â€¢	Inline Telegram UX (buttons, /status, /my_nfts)
	â€¢	NFT preview thumbnails in bot
	â€¢	Optional retry button for failed jobs
	â€¢	Rate limit usage per wallet / user
	â€¢	Add analytics dashboard (if time allows)

â¸»

ğŸ§± Infrastructure Notes

Component	Tool
Message Broker	RabbitMQ (Docker or CloudAMQP)
Worker Runtime	Python + asyncio (Pika or Celery)
Agent Server	FastAPI + Agno SDK
Deployment	Railway / Fly.io / Docker Compose
RAG & VectorDB	Agno VectorDB
Payments	Masumi
NFT Minting	NMKR Studio API


